# Colourful ls output
eval $(dircolors)
LS_COLORS=$LS_COLORS":*.vhd=00;93:*.v=00;93:*.vp=00;93:*.vh=00;93:*.ngc=00;33:"

# Set PS1 variable
export PS1="\[\e[00;37m\]\u@\h:\w\\$ \[\e[0m\]"

# Highlighting function
function color
{
    grep * 2>&1
    grep --color "${1}\|$"
}

# Function to pipe into no-windowed emacs
function ep
{
    TMP=$(mktemp)
    cat > $TMP
    eval "emacs -nw $TMP" < /dev/tty
    rm $TMP
}

# Function to share tmux sessions
function start_shared_tmux
{
    if [ ! -z $TMUX ] ; then
        echo "Already running in multiplexer!"
        exit 1;
    fi

    tmux has-session -t main
    if [ $? -eq 1 ] ; then
        echo "No main here, starting it"
        tmux new-session -s main\; set-option aggressive-resize on\; set-option history-limit 50000
    else
        highest=0
        for session in $(tmux list-sessions)
        do
            if [[ $session =~ ^mirror([[:digit:]]+): ]] ; then
                echo -n "Found mirror with number "
                echo ${BASH_REMATCH[1]}
                if [ ${BASH_REMATCH[1]} -gt ${highest} ] ; then
                    highest=${BASH_REMATCH[1]};
                fi
            fi
        done
        let "newmirror = highest + 1";
        echo "Attaching to mirror $newmirror"
        tmux new-session -s mirror$newmirror -t main \; set-option destroy-unattached on\; set-option aggressive-resize on\; set-option history-limit 50000
    fi
}

# Function to update some environment variables within the session from values of the new shell
function update_env_shared_tmux
{
    export "$(tmux show-env | grep DISPLAY)"
    export "$(tmux show-env | grep SSH_CONNECTION)"
    export "$(tmux show-env | grep SSH_AUTH_SOCK)"
}

# Aliases for convenience
alias ls='ls --color=auto'
alias ll='ls -hl --time-style=long-iso'
alias grep='grep --color=auto'
alias e="emacs -nw"
alias emasc="emacs"
alias tig="tig --all"
alias gitk="gitk --all"
alias log="tail --retry --follow=name"
alias tree="tree -C"
alias gdiff="git diff --no-index"
alias uncolor="sed -r 's/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[m|K]//g'"
alias make="make -j $(grep -c processor /proc/cpuinfo)"
alias ps="ps -eo pid,user:16,pcpu,pmem,stat,args"
alias hg="history | grep"
alias ts="start_shared_tmux"
alias te="update_env_shared_tmux"
alias please='sudo $(fc -ln -1)'

# 256 colors for terminal
export TERM="xterm-256color"

# Some other variables
export EDITOR="emacs -nw"
export LESS="-iR"

# Smart bash completion
if [ -f /etc/bash_completion ]; then
 . /etc/bash_completion
fi
